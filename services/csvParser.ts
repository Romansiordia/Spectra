
import { Sample } from '../types';

declare var Papa: any;

export const DEMO_DATA_STRING = `ID,400,402,404,406,408,410,412,414,416,418,420,422,424,426,428,430,432,434,436,438,440,442,444,446,448,450,452,454,456,458,460,462,464,466,468,470,472,474,476,478,480,Concentration
SMPL_01,0.22,0.23,0.22,0.22,0.22,0.23,0.23,0.24,0.25,0.26,0.27,0.28,0.30,0.32,0.34,0.37,0.40,0.43,0.45,0.47,0.49,0.49,0.48,0.47,0.46,0.45,0.45,0.45,0.45,0.46,0.46,0.47,0.47,0.47,0.48,0.48,0.48,0.48,0.48,0.48,0.48,10.5
SMPL_02,0.25,0.25,0.25,0.26,0.26,0.27,0.28,0.29,0.30,0.32,0.33,0.35,0.37,0.40,0.43,0.46,0.50,0.53,0.56,0.58,0.60,0.60,0.59,0.57,0.55,0.54,0.53,0.53,0.53,0.53,0.54,0.54,0.54,0.55,0.55,0.55,0.55,0.55,0.55,0.55,0.55,12.3
SMPL_03,0.28,0.28,0.29,0.29,0.30,0.31,0.32,0.33,0.35,0.37,0.39,0.41,0.44,0.47,0.50,0.54,0.58,0.61,0.64,0.66,0.68,0.68,0.66,0.64,0.62,0.61,0.60,0.60,0.60,0.60,0.61,0.61,0.61,0.62,0.62,0.62,0.62,0.62,0.62,0.62,0.62,15.1
SMPL_04,0.31,0.31,0.32,0.32,0.33,0.34,0.36,0.37,0.39,0.41,0.43,0.46,0.49,0.52,0.56,0.60,0.64,0.68,0.71,0.73,0.75,0.75,0.73,0.71,0.69,0.67,0.66,0.66,0.66,0.66,0.67,0.67,0.67,0.68,0.68,0.68,0.68,0.68,0.68,0.68,0.68,18.2
SMPL_05,0.19,0.19,0.19,0.19,0.20,0.20,0.21,0.22,0.23,0.24,0.25,0.26,0.28,0.30,0.32,0.35,0.37,0.40,0.42,0.44,0.45,0.45,0.44,0.43,0.42,0.41,0.41,0.41,0.41,0.41,0.42,0.42,0.42,0.42,0.43,0.43,0.43,0.43,0.43,0.43,0.43,8.9
SMPL_06,0.33,0.34,0.34,0.35,0.36,0.37,0.38,0.40,0.42,0.44,0.47,0.50,0.53,0.57,0.61,0.65,0.70,0.74,0.77,0.80,0.82,0.81,0.79,0.77,0.74,0.72,0.71,0.71,0.71,0.71,0.71,0.72,0.72,0.72,0.73,0.73,0.73,0.73,0.73,0.73,0.73,20.1
SMPL_07,0.35,0.36,0.36,0.37,0.38,0.39,0.41,0.42,0.45,0.47,0.50,0.53,0.57,0.61,0.65,0.70,0.75,0.79,0.83,0.85,0.87,0.87,0.85,0.82,0.79,0.77,0.76,0.76,0.76,0.76,0.76,0.77,0.77,0.77,0.78,0.78,0.78,0.78,0.78,0.78,0.78,22.5
SMPL_08,0.26,0.26,0.27,0.27,0.28,0.28,0.29,0.31,0.32,0.34,0.36,0.38,0.41,0.43,0.46,0.50,0.53,0.56,0.59,0.61,0.63,0.63,0.61,0.59,0.57,0.56,0.55,0.55,0.55,0.55,0.55,0.56,0.56,0.56,0.57,0.57,0.57,0.57,0.57,0.57,0.57,13.8
SMPL_09,0.29,0.30,0.30,0.31,0.31,0.32,0.33,0.35,0.36,0.38,0.40,0.43,0.46,0.49,0.52,0.56,0.60,0.64,0.67,0.69,0.71,0.71,0.69,0.67,0.65,0.63,0.62,0.62,0.62,0.62,0.62,0.63,0.63,0.63,0.64,0.64,0.64,0.64,0.64,0.64,0.64,16.4
SMPL_10,0.23,0.23,0.24,0.24,0.25,0.25,0.26,0.27,0.29,0.30,0.32,0.34,0.36,0.38,0.41,0.44,0.47,0.51,0.53,0.56,0.57,0.57,0.56,0.54,0.52,0.51,0.50,0.50,0.50,0.50,0.50,0.51,0.51,0.51,0.52,0.52,0.52,0.52,0.52,0.52,0.52,11.2
SMPL_11,0.38,0.38,0.39,0.40,0.41,0.42,0.43,0.45,0.48,0.50,0.53,0.57,0.61,0.65,0.69,0.74,0.79,0.84,0.88,0.91,0.93,0.92,0.90,0.87,0.84,0.82,0.80,0.80,0.79,0.79,0.79,0.80,0.80,0.80,0.81,0.81,0.81,0.81,0.81,0.81,0.81,25.3
SMPL_12,0.21,0.21,0.21,0.22,0.22,0.23,0.24,0.25,0.26,0.27,0.29,0.30,0.32,0.34,0.37,0.40,0.43,0.46,0.48,0.50,0.52,0.52,0.51,0.50,0.48,0.47,0.46,0.46,0.46,0.46,0.47,0.47,0.47,0.48,0.48,0.48,0.48,0.48,0.48,0.48,0.48,9.7
SMPL_13,0.32,0.32,0.33,0.33,0.34,0.35,0.36,0.38,0.40,0.42,0.44,0.47,0.50,0.54,0.57,0.62,0.66,0.70,0.73,0.76,0.78,0.77,0.75,0.73,0.71,0.69,0.68,0.67,0.67,0.67,0.67,0.68,0.68,0.68,0.69,0.69,0.69,0.69,0.69,0.69,0.69,19.5
SMPL_14,0.24,0.24,0.24,0.25,0.25,0.26,0.27,0.28,0.30,0.31,0.33,0.35,0.37,0.40,0.43,0.46,0.49,0.53,0.55,0.58,0.60,0.59,0.58,0.56,0.54,0.53,0.52,0.52,0.52,0.52,0.52,0.53,0.53,0.53,0.54,0.54,0.54,0.54,0.54,0.54,0.54,11.8
SMPL_15,0.40,0.41,0.41,0.42,0.43,0.44,0.46,0.48,0.50,0.53,0.56,0.60,0.64,0.68,0.73,0.78,0.83,0.88,0.92,0.95,0.97,0.97,0.94,0.91,0.88,0.85,0.84,0.83,0.83,0.83,0.83,0.83,0.84,0.84,0.84,0.84,0.84,0.84,0.84,0.84,0.84,28.1
SMPL_16,0.27,0.27,0.28,0.28,0.29,0.30,0.31,0.32,0.34,0.36,0.38,0.40,0.43,0.46,0.49,0.53,0.57,0.60,0.63,0.65,0.67,0.67,0.65,0.63,0.61,0.59,0.58,0.58,0.58,0.58,0.58,0.59,0.59,0.59,0.60,0.60,0.60,0.60,0.60,0.60,0.60,14.5
SMPL_17,0.30,0.30,0.31,0.31,0.32,0.33,0.34,0.36,0.38,0.40,0.42,0.45,0.48,0.51,0.55,0.59,0.63,0.67,0.70,0.72,0.74,0.74,0.72,0.70,0.68,0.66,0.65,0.65,0.65,0.65,0.65,0.66,0.66,0.66,0.67,0.67,0.67,0.67,0.67,0.67,0.67,17.3
SMPL_18,0.36,0.37,0.37,0.38,0.39,0.40,0.42,0.44,0.46,0.49,0.52,0.55,0.59,0.63,0.67,0.72,0.77,0.82,0.86,0.89,0.91,0.90,0.88,0.85,0.82,0.80,0.78,0.78,0.78,0.78,0.78,0.78,0.79,0.79,0.79,0.79,0.79,0.79,0.79,0.79,0.79,23.9
SMPL_19,0.20,0.20,0.21,0.21,0.21,0.22,0.23,0.24,0.25,0.26,0.28,0.29,0.31,0.33,0.36,0.39,0.42,0.45,0.47,0.49,0.51,0.51,0.50,0.48,0.47,0.46,0.45,0.45,0.45,0.45,0.46,0.46,0.46,0.47,0.47,0.47,0.47,0.47,0.47,0.47,0.47,9.3
SMPL_20,0.34,0.34,0.35,0.35,0.36,0.37,0.39,0.40,0.42,0.45,0.47,0.50,0.54,0.58,0.62,0.66,0.71,0.76,0.79,0.82,0.84,0.84,0.82,0.79,0.77,0.75,0.73,0.73,0.73,0.73,0.73,0.73,0.74,0.74,0.74,0.74,0.74,0.74,0.74,0.74,0.74,21.5
`;

type ParseResult = {
    wavelengths: number[];
    samples: Sample[];
    analyticalProperty: string;
};

export function parseCSV(
    fileOrString: File | string,
    onComplete: (results: ParseResult) => void
) {
    Papa.parse(fileOrString, {
        header: false,
        dynamicTyping: true,
        skipEmptyLines: true,
        complete: (results: { data: any[][] }) => {
            const data = results.data;
            if (data.length < 2 || data[0].length < 3) {
                alert("Formato de CSV inválido. Se requieren al menos 2 filas y 3 columnas.");
                return;
            }

            const header = data[0];
            const numCols = header.length;
            const analyticalProperty = header[numCols - 1];
            const wavelengths = header.slice(1, numCols - 1).map(Number);
            
            if (wavelengths.some(isNaN)) {
                alert("Cabecera de longitudes de onda contiene valores no numéricos.");
                return;
            }

            const samplesData: Sample[] = data.slice(1).map((row, index): Sample | null => {
                if (row.length !== numCols) {
                    console.warn(`Fila ${index + 2} ignorada por tener un número incorrecto de columnas.`);
                    return null;
                }

                const id = row[0];
                const analyticalValue = row[numCols - 1];
                if (typeof analyticalValue !== 'number' || isNaN(analyticalValue)) {
                    console.warn(`Fila ${index + 2} (ID: ${id}) ignorada: el valor de la propiedad no es numérico.`);
                    return null;
                }

                const values = row.slice(1, numCols - 1);
                if (values.some(v => typeof v !== 'number' || isNaN(v))) {
                    console.warn(`Fila ${index + 2} (ID: ${id}) ignorada: el espectro contiene valores no numéricos.`);
                    return null;
                }
                
                const color = `hsl(${(index * 360 / (data.length - 1)) % 360}, 70%, 50%)`;

                return {
                    id,
                    values,
                    color,
                    active: true,
                    analyticalValue,
                };
            }).filter((s): s is Sample => s !== null);

            onComplete({ wavelengths, samples: samplesData, analyticalProperty });
        },
        error: (error: Error) => {
            alert(`Error al parsear el CSV: ${error.message}`);
        }
    });
}
